trigger: none # Only run this pipeline when manually triggered

resources:
  pipelines:
    - pipeline: vscode-azurevirtualmachines # identifier to use in pipeline resource variables
      source: \Azure Tools\VSCode\Extensions\vscode-azurevirtualmachines # name of the pipeline that produces the artifacts

steps:
  - checkout: none
  - script: |
      echo $(resources.pipeline.vscode-azurevirtualmachines.pipelineID)
      echo $(resources.pipeline.vscode-azurevirtualmachines.runName)
      echo $(resources.pipeline.vscode-azurevirtualmachines.runID)
      echo $(resources.pipeline.vscode-azurevirtualmachines.runURI)
      echo $(resources.pipeline.vscode-azurevirtualmachines.sourceBranch)
      echo $(resources.pipeline.vscode-azurevirtualmachines.sourceCommit)
      echo $(resources.pipeline.vscode-azurevirtualmachines.sourceProvider)
      echo $(resources.pipeline.vscode-azurevirtualmachines.requestedFor)
      echo $(resources.pipeline.vscode-azurevirtualmachines.requestedForID)

  - task: DownloadPipelineArtifact@2
    displayName: Download VSIX
    inputs:
      source: specific # download from a different run
      project: DevDiv
      definition: $(resources.pipeline.vscode-azurevirtualmachines.pipelineID)
      buildVersionToDownload: specific
      runId: $(resources.pipeline.vscode-azurevirtualmachines.runID)
      artifact: Build Root
      targetPath: $(System.DefaultWorkingDirectory)

  - script: |
      dir

  - script: npm i -g @vscode/vsce
    displayName: "Install vsce"

  - task: AzureCLI@2
    displayName: Get userId of WIF
    inputs:
      azureSubscription: AzCodeReleases
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        az account show

  - task: AzureCLI@2
    displayName: Get userId of WIF 2
    inputs:
      azureSubscription: AzCodeReleases
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        az

  # - task: AzureCLI@2
  #   displayName: Run vsce publish
  #   inputs:
  #     azureSubscription: vscode-marketplace
  #     scriptType: pscore
  #     scriptLocation: inlineScript
  #     inlineScript: |
  #       $publishArgs = @(
  #         '--azure-credential'
  #         '--packagePath'
  #         '$(drop)/vscode-azurearcenabledmachines-$(version).vsix'
  #       )
  #       npm run publish -- @publishArgs
